<!--group members count calculation-->
<%
  const m = group?.members || {};
  const membersCount =
    (m?.admins?.length || 0) +
    (m?.managers?.length || 0) +
    (m?.plainUsers?.length || 0);
%>

<%
  const inAdmins = Array.isArray(m?.admins) && m.admins.some(a => String(a) === String(user._id));
  const inManagers = Array.isArray(m?.managers) && m.managers.some(x => String(x) === String(user._id));
  const inPlain = Array.isArray(m?.plainUsers) && m.plainUsers.some(p => String(p) === String(user._id));
  const isMember = !!(inAdmins || inManagers || inPlain);
%>



<!------------------------------ top group area ------------------------------>

<!-- group cover image if exists -->
<div class="group-header">
  <% if (coverUrl) { %>
    <img class="group-cover" src="<%= coverUrl %>" alt="<%= group.displayName %> cover">
  <% } %>
</div>

<!-- Group header -->
<div class="row align-items-center justify-content-between mb-3">
  <!-- Title -->
  <div class="col">
    <h1 class="post-title mb-0" id="group-title">
      <%= group.displayName %>
    </h1>
  </div>

  <!-- Actions -->
  <div class="col-auto d-flex align-items-center gap-2">
    <!-- Follow -->
    <button class="btn <%= isMember ? 'btn-outline-primary' : 'btn-primary' %> btn-sm" id="follow-group-btn"
      data-group="<%= group.groupName %>" data-followed="<%= isMember ? '1' : '0' %>">
      <%= isMember ? 'Unfollow' : 'Follow Group' %>
    </button>
    
    <!-- Members -->
    <button class="btn btn-outline-secondary btn-sm" id="group-members-btn" data-group="<%= group.groupName %>">
      Members (<%= membersCount %>)
    </button>

    <!-- Settings (admins only) -->
    <% if (isAdmin) { %>
      <button class="btn btn-secondary btn-sm" id="group-settings-btn"
              data-group="<%= group.groupName %>">
        Group Settings
      </button>
    <% } %>
  </div>
</div>

<!------------------------------ END OF top group area ------------------------------>

<!------------------------------ main content area ------------------------------>

 <!-- 2 MAIN CONTENT COLS part -->
<div id="group-columns">
  <!-- LEFT COL: posts using main_page.js -->
  <div class="left-col">
    <ul id="post-list" class="post-list" data-group="<%= group.groupName %>">
    </ul>
  </div>

  <!-- RIGHT COL: group info -->
  <div class="right-col">
    <!-- About box that matches a post exactly -->
    <div id="group-about" class="card post">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h3 class="post-title mb-0">About this Group:</h3>
        <div class="post-header-right-side"></div>
      </div>
  
      <div class="card-body post-block">
        <p class="post-text mb-0">
          <%= group?.description || 'No description yet.' %>
        </p>
      </div>
    </div>
  
    <!-- === Members === -->
     <div id="members-card-anchor"></div>
    <div id="group-members-card" class="card post" data-group="<%= group.groupName %>">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h3 class="post-title mb-0">
          Group Members
          <span class="text-muted">(<span id="members-count">
              <%= membersCount %>
            </span>)</span>
        </h3>
      </div>
  
      <div class="card-body post-block">
        <h4 class="text-muted mb-2">Admins</h4>
        <ul class="members-list mb-3" id="members-admins"></ul>
  
        <h4 class="text-muted mb-2">Managers</h4>
        <ul class="members-list mb-3" id="members-managers"></ul>
  
        <h4 class="text-muted mb-2">Members</h4>
        <ul class="members-list" id="members-plain"></ul>
      </div>
    </div>
  </div>
</div>
<script type="module" src="/contentWindow/group-feed.js"></script>

<!------------------------------ END OF main content area ------------------------------>
